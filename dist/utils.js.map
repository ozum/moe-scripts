{"version":3,"sources":["../src/utils.js"],"names":["fs","require","path","arrify","has","readPkgUp","which","sync","cwd","realpathSync","process","pkg","pkgPath","appDirectory","dirname","resolveKcdScripts","name","resolve","replace","resolveBin","modName","executable","pathFromWhich","_error","modPkgPath","modPkgDir","bin","binPath","fullPathToBin","join","error","fromRoot","p","hasFile","existsSync","ifFile","files","t","f","some","file","hasPkgProp","props","prop","hasPkgSubProp","map","pkgProp","ifPkgSubProp","hasScript","hasPeerDep","hasDep","hasDevDep","hasAnyDep","fn","args","ifPeerDep","ifDep","ifDevDep","ifAnyDep","deps","ifScript","parseEnv","def","envIsSet","JSON","parse","env","err","hasOwnProperty","getConcurrentlyArgs","scripts","killOthers","colors","Object","entries","reduce","all","script","prefixColors","keys","pColors","_s","i","concat","length","values","stringify","s","filter","Boolean","isOptedOut","key","contents","readFileSync","includes","isOptedIn","module","exports"],"mappings":"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","file":"utils.js","sourcesContent":["const fs = require('fs')\nconst path = require('path')\nconst arrify = require('arrify')\nconst has = require('lodash.has')\nconst readPkgUp = require('read-pkg-up')\nconst which = require('which')\n\nconst {pkg, path: pkgPath} = readPkgUp.sync({\n  cwd: fs.realpathSync(process.cwd()),\n})\nconst appDirectory = path.dirname(pkgPath)\n\nfunction resolveKcdScripts() {\n  if (pkg.name === 'moe-scripts') {\n    return require.resolve('./').replace(process.cwd(), '.')\n  }\n  return resolveBin('moe-scripts')\n}\n\n// eslint-disable-next-line complexity\nfunction resolveBin(modName, {executable = modName, cwd = process.cwd()} = {}) {\n  let pathFromWhich\n  try {\n    pathFromWhich = fs.realpathSync(which.sync(executable))\n  } catch (_error) {\n    // ignore _error\n  }\n  try {\n    const modPkgPath = require.resolve(`${modName}/package.json`)\n    const modPkgDir = path.dirname(modPkgPath)\n    const {bin} = require(modPkgPath)\n    const binPath = typeof bin === 'string' ? bin : bin[executable]\n    const fullPathToBin = path.join(modPkgDir, binPath)\n    if (fullPathToBin === pathFromWhich) {\n      return executable\n    }\n    return fullPathToBin.replace(cwd, '.')\n  } catch (error) {\n    if (pathFromWhich) {\n      return executable\n    }\n    throw error\n  }\n}\n\nconst fromRoot = (...p) => path.join(appDirectory, ...p)\nconst hasFile = (...p) => fs.existsSync(fromRoot(...p))\nconst ifFile = (files, t, f) =>\n  arrify(files).some(file => hasFile(file)) ? t : f\n\nconst hasPkgProp = props => arrify(props).some(prop => has(pkg, prop))\n\nconst hasPkgSubProp = pkgProp => props =>\n  hasPkgProp(arrify(props).map(p => `${pkgProp}.${p}`))\n\nconst ifPkgSubProp = pkgProp => (props, t, f) =>\n  hasPkgSubProp(pkgProp)(props) ? t : f\n\nconst hasScript = hasPkgSubProp('scripts')\nconst hasPeerDep = hasPkgSubProp('peerDependencies')\nconst hasDep = hasPkgSubProp('dependencies')\nconst hasDevDep = hasPkgSubProp('devDependencies')\nconst hasAnyDep = args => [hasDep, hasDevDep, hasPeerDep].some(fn => fn(args))\n\nconst ifPeerDep = ifPkgSubProp('peerDependencies')\nconst ifDep = ifPkgSubProp('dependencies')\nconst ifDevDep = ifPkgSubProp('devDependencies')\nconst ifAnyDep = (deps, t, f) => (hasAnyDep(arrify(deps)) ? t : f)\nconst ifScript = ifPkgSubProp('scripts')\n\nfunction parseEnv(name, def) {\n  if (envIsSet(name)) {\n    try {\n      return JSON.parse(process.env[name])\n    } catch (err) {\n      return process.env[name]\n    }\n  }\n  return def\n}\n\nfunction envIsSet(name) {\n  return (\n    process.env.hasOwnProperty(name) &&\n    process.env[name] &&\n    process.env[name] !== 'undefined'\n  )\n}\n\nfunction getConcurrentlyArgs(scripts, {killOthers = true} = {}) {\n  const colors = [\n    'bgBlue',\n    'bgGreen',\n    'bgMagenta',\n    'bgCyan',\n    'bgWhite',\n    'bgRed',\n    'bgBlack',\n    'bgYellow',\n  ]\n  scripts = Object.entries(scripts).reduce((all, [name, script]) => {\n    if (script) {\n      all[name] = script\n    }\n    return all\n  }, {})\n  const prefixColors = Object.keys(scripts)\n    .reduce(\n      (pColors, _s, i) =>\n        pColors.concat([`${colors[i % colors.length]}.bold.reset`]),\n      [],\n    )\n    .join(',')\n\n  // prettier-ignore\n  return [\n    killOthers ? '--kill-others-on-fail' : null,\n    '--prefix', '[{name}]',\n    '--names', Object.keys(scripts).join(','),\n    '--prefix-colors', prefixColors,\n    ...Object.values(scripts).map(s => JSON.stringify(s)), // stringify escapes quotes âœ¨\n  ].filter(Boolean)\n}\n\nfunction isOptedOut(key, t = true, f = false) {\n  if (!fs.existsSync(fromRoot('.opt-out'))) {\n    return f\n  }\n  const contents = fs.readFileSync(fromRoot('.opt-out'), 'utf-8')\n  return contents.includes(key) ? t : f\n}\n\nfunction isOptedIn(key, t = true, f = false) {\n  if (!fs.existsSync(fromRoot('.opt-in'))) {\n    return f\n  }\n  const contents = fs.readFileSync(fromRoot('.opt-in'), 'utf-8')\n  return contents.includes(key) ? t : f\n}\n\nmodule.exports = {\n  appDirectory,\n  envIsSet,\n  fromRoot,\n  getConcurrentlyArgs,\n  hasFile,\n  hasPkgProp,\n  hasScript,\n  ifAnyDep,\n  ifDep,\n  ifDevDep,\n  ifFile,\n  ifPeerDep,\n  ifScript,\n  isOptedIn,\n  isOptedOut,\n  parseEnv,\n  pkg,\n  resolveBin,\n  resolveKcdScripts,\n}\n"]}