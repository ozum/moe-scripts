{"version":3,"sources":["../../../src/scripts/build/rollup.js"],"names":["path","require","fs","spawn","mkdirp","glob","rimraf","yargsParser","hasFile","resolveBin","fromRoot","getConcurrentlyArgs","crossEnv","rollup","args","process","argv","slice","here","join","__dirname","p","hereRelative","replace","cwd","parsedArgs","useBuiltinConfig","includes","config","environment","watch","formats","bundle","split","defaultEnv","getCommand","env","flags","filter","Boolean","buildPreact","scripts","getPReactScripts","getCommands","cleanBuildDirs","sync","result","stdio","status","preactPkg","preactDir","cjsFile","esmFile","writeFileSync","JSON","stringify","main","relative","module","reactCommands","prefixKeys","preactCommands","preact","Object","assign","prefix","object","entries","reduce","cmds","key","value","format","formatName","minify","nodeEnv","sourceMap","buildMinify","BUILD_NODE","BUILD_REACT_NATIVE","exit"],"mappings":"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","file":"rollup.js","sourcesContent":["const path = require(\"path\");\nconst fs = require(\"fs\");\nconst spawn = require(\"cross-spawn\");\nconst mkdirp = require(\"mkdirp\");\nconst glob = require(\"glob\");\nconst rimraf = require(\"rimraf\");\nconst yargsParser = require(\"yargs-parser\");\nconst { hasFile, resolveBin, fromRoot, getConcurrentlyArgs } = require(\"../../utils\");\n\nconst crossEnv = resolveBin(\"cross-env\");\nconst rollup = resolveBin(\"rollup\");\nconst args = process.argv.slice(2);\nconst here = p => path.join(__dirname, p);\nconst hereRelative = p => here(p).replace(process.cwd(), \".\");\nconst parsedArgs = yargsParser(args);\n\nconst useBuiltinConfig = !args.includes(\"--config\") && !hasFile(\"rollup.config.js\");\nconst config = useBuiltinConfig ? `--config ${hereRelative(\"../../config/rollup.config.js\")}` : args.includes(\"--config\") ? \"\" : \"--config\"; // --config will pick up the rollup.config.js file\n\nconst environment = parsedArgs.environment ? `--environment ${parsedArgs.environment}` : \"\";\nconst watch = parsedArgs.watch ? \"--watch\" : \"\";\n\nlet formats = [\"esm\", \"cjs\", \"umd\", \"umd.min\"];\n\nif (typeof parsedArgs.bundle === \"string\") {\n  formats = parsedArgs.bundle.split(\",\");\n}\n\nconst defaultEnv = \"BUILD_ROLLUP=true\";\n\nconst getCommand = (env, ...flags) => [crossEnv, defaultEnv, env, rollup, config, environment, watch, ...flags].filter(Boolean).join(\" \");\n\nconst buildPreact = args.includes(\"--p-react\");\nconst scripts = buildPreact ? getPReactScripts() : getConcurrentlyArgs(getCommands());\n\nconst cleanBuildDirs = !args.includes(\"--no-clean\");\n\nif (cleanBuildDirs) {\n  rimraf.sync(fromRoot(\"dist\"));\n}\n\nif (buildPreact) {\n  if (cleanBuildDirs) {\n    rimraf.sync(fromRoot(\"preact\"));\n  }\n  mkdirp.sync(fromRoot(\"preact\"));\n}\n\nconst result = spawn.sync(resolveBin(\"concurrently\"), scripts, {\n  stdio: \"inherit\",\n});\n\nif (result.status === 0 && buildPreact && !args.includes(\"--no-package-json\")) {\n  const preactPkg = fromRoot(\"preact/package.json\");\n  const preactDir = fromRoot(\"preact\");\n  const cjsFile = glob.sync(fromRoot(\"preact/**/*.cjs.js\"))[0];\n  const esmFile = glob.sync(fromRoot(\"preact/**/*.esm.js\"))[0];\n  fs.writeFileSync(\n    preactPkg,\n    JSON.stringify(\n      {\n        main: path.relative(preactDir, cjsFile),\n        \"jsnext:main\": path.relative(preactDir, esmFile),\n        module: path.relative(preactDir, esmFile),\n      },\n      null,\n      2,\n    ),\n  );\n}\n\nfunction getPReactScripts() {\n  const reactCommands = prefixKeys(\"react.\", getCommands());\n  const preactCommands = prefixKeys(\"preact.\", getCommands({ preact: true }));\n  return getConcurrentlyArgs(Object.assign(reactCommands, preactCommands));\n}\n\nfunction prefixKeys(prefix, object) {\n  return Object.entries(object).reduce((cmds, [key, value]) => {\n    cmds[`${prefix}${key}`] = value;\n    return cmds;\n  }, {});\n}\n\nfunction getCommands({ preact = false } = {}) {\n  return formats.reduce((cmds, format) => {\n    const [formatName, minify = false] = format.split(\".\");\n    const nodeEnv = minify ? \"production\" : \"development\";\n    const sourceMap = formatName === \"umd\" ? \"--sourcemap\" : \"\";\n    const buildMinify = Boolean(minify);\n\n    cmds[format] = getCommand(\n      [\n        `BUILD_FORMAT=${formatName}`,\n        `BUILD_MINIFY=${buildMinify}`,\n        `NODE_ENV=${nodeEnv}`,\n        `BUILD_PREACT=${preact}`,\n        `BUILD_NODE=${process.env.BUILD_NODE || false}`,\n        `BUILD_REACT_NATIVE=${process.env.BUILD_REACT_NATIVE || false}`,\n      ].join(\" \"),\n      sourceMap,\n    );\n    return cmds;\n  }, {});\n}\n\nprocess.exit(result.status);\n"]}